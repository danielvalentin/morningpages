<?php defined('SYSPATH') or die('No direct script access.');class Controller_Cms_Ajax_Blocks extends Controller {		public function action_get()	{			}		public function action_getchildren()	{		$parent = ORM::factory('Block', arr::get($_GET, 'id', false));		if(!$parent->loaded())		{			ajax::error(__('Block not found. Has it been deleted?'));		}				$children = array();		if((bool)$parent->blocks->count_all())		{			foreach($parent->blocks->find_all() as $block)			{				$children[] = $block->info();			}		}		ajax::success('', array(			'blocks' => $children		));	}		public function action_setorder()	{		if($_POST)		{			foreach($_POST as $id => $order)			{				$block = ORM::factory('Block',$id);				if($block->loaded())				{					$block->order = $order;					$block->save();				}			}		}	}		public function action_files()	{		$block = ORM::factory('Block',$this->request->param('id'));		if(!$block->loaded())		{			ajax::error('Blokken blev ikke fundet.');		}		$json = array();		$files = $block->files->find_all();		if((bool)$files->count())		{			foreach($files as $blockfile)			{				$file = ORM::factory('File', $blockfile->file_id);				$info = $file->info();				$info['blockfileid'] = $blockfile->id;				$info['alt'] = $blockfile->alt;				$info['description'] = $blockfile->description;				$json[] = $info;			}		}		ajax::success('',array('files' => json_encode($json)));	}		public function action_collapse()	{		$block = ORM::factory('Block',arr::get($_POST,'id'));		if(!$block->loaded())		{			ajax::error('Blokken blev ikke fundet.');		}		try {			$block->collapsed = arr::get($_POST, 'collapsed', '0');			$block->save();			ajax::success('ok');		}		catch(exception $e)		{			ajax::error('Der opstod en fejl. Siden sagde: '.$e->getMessage());		}	}		public function action_add()	{		$blocktype = ORM::factory('Blocktype',arr::get($_POST, 'blocktype_id'));		if(!$blocktype->loaded())		{			ajax::error('Bloktypen blev ikke fundet.');		}		$content = ORM::factory('Content',arr::get($_POST, 'content_id'));		if(!$content->loaded())		{			ajax::error('Indholdet blev ikke fundet.');		}		$block = ORM::factory('Block');		$block->content_id = $content->id;		$block->blocktype_id = $blocktype->id;		$block->parent = arr::get($_POST, 'parent',0);		$block->order = ORM::factory('Block')->where('content_id','=',$content->id)->where('parent','=',$block->parent)->count_all();		try {			$block->save();			$view = View::factory('Cms/Content/blocks/block');			$view->block = $block;			ajax::success('Ok', array('block' => $block->info()));		}		catch(exception $e)		{			ajax::error('Blokken kunne ikke gemmes. Siden sagde: '.$e->getMessage());		}	}		public function action_removefile()	{		$file = ORM::factory('Block_File', arr::get($_POST, 'id', false));		if(!$file->loaded())		{			ajax::error('Filen blev ikke fundet.');		}		try		{			$file->delete();			ajax::success();		}		catch(exception $e)		{			ajax::error('Der opstod en fejl og filen kunne ikke slettes. Siden sagde: '.$e->getMessage());		}	}		public function action_delete()	{		$block = ORM::factory('Block',arr::get($_POST,'block_id'));		if(!$block->loaded())		{			ajax::error('Blokken blev ikke fundet.');		}		try {			$block->delete();			ajax::success('ok');		}		catch(exception $e)		{			ajax::error('Der opstod en fejl og blokken kunne ikke slettes. Siden sagde: '.$e->getMessage());		}	}	}