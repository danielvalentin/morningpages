<?php defined('SYSPATH') or die('No direct script access.');class Controller_Cms_Ajax_Gallery extends Controller {		public function action_imageadjust()	{		$img = ORM::factory('File',arr::get($_GET, 'fileid'));		if(!$img->loaded())		{			ajax::error('Billedet blev ikke fundet');		}		$image = false;		$path = 'files/'.$img->filename();		if($img->type == 'image/jpeg')		{			$image = imagecreatefromjpeg($path);		}		if($img->type == 'image/gif')		{			$image = imagecreatefromgif($path);		}		if($img->type == 'image/png')		{			$image = imagecreatefrompng($path);		}		if($img->type == 'image/bmp')		{			$image = imagecreatefromwbmp($path); // Hmm		}		if(!$image)		{			ajax::error('Ukendt filtype');		}		if(isset($_GET['grayscale']) && $_GET['grayscale'] == 1)		{			imagefilter($image, IMG_FILTER_GRAYSCALE);		}		if(isset($_GET['blur']))		{			imagefilter($image, IMG_FILTER_GAUSSIAN_BLUR, $_GET['blur']);		}		if(isset($_GET['brightness']))		{			imagefilter($image, IMG_FILTER_BRIGHTNESS, $_GET['brightness']);		}		if(isset($_GET['negate']) && $_GET['negate'] == 1)		{			imagefilter($image, IMG_FILTER_NEGATE);		}		if(isset($_GET['contrast']))		{			imagefilter($image, IMG_FILTER_CONTRAST,$_GET['contrast']);		}		if(isset($_GET['emboss']) && $_GET['emboss'] == 1)		{			imagefilter($image, IMG_FILTER_EMBOSS);		}		if(isset($_GET['edgedetect']) && $_GET['edgedetect'] == 1)		{			imagefilter($image, IMG_FILTER_EDGEDETECT);		}		if(isset($_GET['pixelate']))		{			imagefilter($image, IMG_FILTER_PIXELATE, $_GET['pixelate']);		}		if(isset($_GET['smooth']))		{			imagefilter($image, IMG_FILTER_SMOOTH, $_GET['smooth']);		}		if(isset($_GET['colorize']))		{			imagefilter($image, IMG_FILTER_COLORIZE, 100,100,100);		}		if(isset($_GET['crop']) && $_GET['crop'] == 1)		{			list($width, $height) = getimagesize($path);			$percentw = $width / $_GET['samplewidth'];			$percenth = $height / $_GET['sampleheight'];			$newimg = imagecreatetruecolor($_GET['w'] * $percentw, $_GET['h'] * $percenth);			imagecopyresampled($newimg, $image, 0, 0, $_GET['x'] * $percentw, $_GET['y'] * $percenth, $width, $height, $width, $height);			$image = $newimg;		}		if(arr::get($_GET, 'scale',false) == 1)		{			list($orgwidth, $orgheight) = getimagesize($path);			$width = arr::get($_GET, 'scalew',$orgwidth);			$height = arr::get($_GET, 'scaleh',$orgheight);			$newimg = imagecreatetruecolor($width, $height);			imagecopyresampled($newimg, $image, 0, 0, 0, 0, $width, $height, $orgwidth, $orgheight);			$image = $newimg;		}		header('content-type:image/jpeg');		if($img->type == 'image/jpeg')		{			echo imagejpeg($image);		}		if($img->type == 'image/gif')		{			echo imagegif($image);		}		if($img->type == 'image/png')		{			echo imagepng($image);		}		if($img->type == 'image/bmp')		{			echo imagewbmp($image);		}	}		public function action_removefile()	{		$block = ORM::factory('Block',arr::get($_POST, 'blockid'));		if(!$block->loaded())		{			ajax::error('Block not found');		}		try {			$block->remove('files',arr::get($_POST,'fileid'));			ajax::success('ok');		}		catch(exception $e)		{			ajax::error($e->getMessage());		}	}		public function action_upload()	{		$block = ORM::factory('Block',arr::get($_POST, 'blockid'));		if(!$block->loaded())		{			ajax::error('Block not found');		}		try {			$files = arr::get($_FILES, 'files', false);			$file = ORM::factory('File');			$file->upload($files);			$file->save();			$block->add('files',$file->id );			$img = '<img src="'.$file->get_thumb(75,75).'" class="img-polaroid" />';			$view = View::factory('Cms/Content/blocks/gallery/image');			$view->file = $file;			ajax::success('OK', array('file' => $view->render()));		}		catch(exception $e)		{			ajax::error('Fejl! Kunne ikke uploade filen: '.$e->getMessage());		}	}	}