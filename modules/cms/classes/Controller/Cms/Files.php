<?php defined('SYSPATH') or die('No direct script access.');class Controller_Cms_Files extends Controller_Cms {		public function action_index()	{		$limit = 30;		$page = arr::get($_GET, 'p', 1);		$page = $page-1;		$files = ORM::factory('File')			->limit($limit)			->offset($page*$limit)			->find_all();		$filesarr = array();		if((bool)$files->count())		{			foreach($files as $file)			{				$filesarr[] = $file->info();			}		}		$total = ORM::factory('File')->count_all();		$total = ceil($total/$limit);				$view = View::factory('Cms/Files/index2');		reply::ok($view, 'files', array(			'viewModel' => 'viewModels/Files/index2',			'files' => $filesarr		));	}		public function action_edit()	{		$file = ORM::factory('file',$this->request->param('id'));		if(!$file->loaded())		{			notes::add('error', 'Filen blev ikke fundet!');			cms::redirect('files');		}		if($_POST)		{			$filename = arr::get($_POST,'filename','');			if(empty($filename))			{				$filename = $file->filename;			}			if($filename != $file->filename)			{				$filename = files::fixname($filename);				$filename = files::get_available_filename('files/', $filename, $file->ext);				rename('files/'.$file->filename(),'files/'.$filename.'.'.$file->ext);				$versions = $file->versions->find_all();				if((bool)$versions->count()) foreach($versions as $version)				{					$version->delete();				}			}			$file->filename = $filename;			$file->alt = arr::get($_POST, 'alt','');			$file->description = arr::get($_POST, 'description','');			try {				$file->save();				cms::redirect('files/edit/'.$file->id);			}			catch(exception $e)			{				notes::add('error','Filen kunne ikke gemmes! Siden sagde: '.$e->getMessage());			}		}		$this->bind('file',$file);	}		public function action_imgedit()	{		$file = ORM::factory('file',$this->request->param('id'));		if(!$file->loaded())		{			notes::add('error', 'Filen blev ikke fundet!');			cms::redirect('files');		}		$this->load_css('media/libs/jcrop/css/jquery.Jcrop.min.css');		$this->load_script('media/libs/jcrop/js/jquery.Jcrop.min.js');		$this->bind('file',$file);	}	}