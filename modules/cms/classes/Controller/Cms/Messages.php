<?php defined('SYSPATH') or die('No direct script access.');class Controller_Cms_Messages extends Controller_Cms {		public function action_index()	{		$user = user::get();		$messages = array();		$usermessages = $user->messages			->find_all();		if((bool)$usermessages->count())		{			foreach($usermessages as $message)			{				$messages[] = $message->info();			}		}		$roles = $user->roles->find_all();		$roleids = array();		if((bool)$roles->count())		{			foreach($roles as $role)			{				$roleids[] = $role->id;			}		}		if((bool)count($roleids))		{			$rolemessages = ORM::factory('Message')				->where('role_id','in', $roleids)				->where('user_id','!=',$user->id)				->find_all();			if((bool)$rolemessages->count())			{				foreach($rolemessages as $message)				{					$messages[] = $message->info();				}			}		}				reply::ok(View::factory('Cms/Messages/index',array(			'messages' => $messages,			'roles' => user::get()->roles->find_all()->as_array()		)), 'messages', array(			'viewModel' => 'viewModels/Messages/index',			'messages' => $messages		));	}		public function action_message()	{		$message = ORM::factory('Message', $this->request->param('id'));		if(!$message->loaded())		{			ajax::redirect('#/messages', __('The message wasn\'t found. Has it already been deleted?'));		}		$info = $message->info();		if($message->read == 0)		{			$message->set_read();		}		reply::ok(View::factory('Cms/Messages/message',array(			'message' => $message		)), 'messages', array(			'viewModel' => 'viewModels/Messages/message',			'message' => $info		));	}	}