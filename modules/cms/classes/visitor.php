<?php defined('SYSPATH') or die('No direct script access.');abstract class visitor {		public static function save_update_current()	{		if(true||!user::logged('admin'))		{			$session = Session::instance();			$visitor = ORM::factory('Visitor', $session->get('active_visitor'));			$base = request::detect_uri();			$queries = ((isset($_GET)&&!empty($_GET)) ? '?' . http_build_query($_GET) : '');			$uri = request::detect_uri() . $queries;			//substr($base, 1, strlen($base))			if($visitor->loaded()&&$uri==$visitor->page)			{				// This is just a reload of the current page.				return;			}			if(!$visitor->loaded())			{				$numvisits = cookie::get('numvisits');				if(!$numvisits) $numvisits = 0;				cookie::set('numvisits', $numvisits+1);				$visitor->numvisits = $numvisits+1;				$visitor->start = time();				$visitor->referrer = isset($_SERVER['HTTP_REFERER'])?$_SERVER['HTTP_REFERER']:'';				$visitor->ip = isset($_SERVER['REMOTE_ADDR'])?$_SERVER['REMOTE_ADDR']:'';				$visitor->geolocation = 'todo';			}			if(empty($visitor->client))			{				$visitor->client = (isset($_SERVER['HTTP_USER_AGENT'])?$_SERVER['HTTP_USER_AGENT']:'');			}			$visitor->page = $uri;			$history = json_decode($visitor->history);			if(!is_array($history))			{				$history = array();			}			$history[] = $uri;			$visitor->history = json_encode($history);			$visitor->time = time();			$visitor->save();			$session->set('active_visitor', $visitor->id);		}	}	}